<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rendimiento del Agente</title>

  <!-- Librerías -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --verde-oscuro: #006d3c;
      --verde-claro: #a6e3a1;
      --blanco: #ffffff;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      background-color: var(--blanco);
      color: #222;
    }

    header {
      background-color: var(--verde-oscuro);
      color: var(--blanco);
      padding: 1.5rem;
      text-align: center;
      font-size: 1.5rem;
    }

    #cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1rem;
      padding: 1rem 2rem;
    }

    .card {
      background-color: var(--verde-claro);
      border-left: 6px solid var(--verde-oscuro);
      border-radius: 12px;
      padding: 1rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      text-align: center;
    }

    .card .value {
      font-size: 1.8rem;
      color: var(--verde-oscuro);
    }

    #charts {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 2rem;
      padding: 2rem;
    }

    .chart-container {
      background-color: var(--blanco);
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    #calendar {
      padding: 2rem;
    }

    #calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: .5rem;
      margin-top: 1rem;
    }

    #calendar-grid div {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: .5rem;
      min-height: 80px;
      position: relative;
      font-size: .9rem;
    }

    #calendar-grid div span {
      display: block;
      color: var(--verde-oscuro);
      font-weight: bold;
    }

    footer {
      text-align: center;
      background-color: var(--verde-oscuro);
      color: var(--blanco);
      padding: 1rem;
      margin-top: 2rem;
    }
  </style>
</head>
<body>
  <header>
    <h1>Rendimiento del Agente</h1>
  </header>

  <main>
    <section id="cards">
      <div class="card" id="total-citas">
        <h2>Total de citas</h2>
        <p class="value">0</p>
      </div>
      <div class="card" id="agentes-activos">
        <h2>Agentes activos</h2>
        <p class="value">0</p>
      </div>
      <div class="card" id="citas-hoy">
        <h2>Citas hoy</h2>
        <p class="value">0</p>
      </div>
      <div class="card" id="promedio-tiempo">
        <h2>Promedio entre creación y cita</h2>
        <p class="value">0 días</p>
      </div>
    </section>

    <section id="charts">
      <div class="chart-container">
        <h3>Citas por agente</h3>
        <canvas id="citasPorAgente"></canvas>
      </div>
      <div class="chart-container">
        <h3>Citas por estado</h3>
        <canvas id="statusCitas"></canvas>
      </div>
    </section>

    <section id="calendar">
      <h3>Calendario de citas</h3>
      <div id="calendar-grid"></div>
    </section>
  </main>

  <footer>
    <p>¿Necesitas asistencia? Contáctanos: <strong>8123836266</strong></p>
  </footer>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      fetchExcelData();
    });

    async function fetchExcelData() {
      try {
        const response = await fetch("TESTDB.xlsx");
        const arrayBuffer = await response.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: "array" });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const data = XLSX.utils.sheet_to_json(sheet);
        renderDashboard(data);
      } catch (error) {
        console.error("Error al cargar el archivo Excel:", error);
        alert("No se pudo cargar TESTDB.xlsx. Asegúrate de que esté en la misma carpeta que este HTML.");
      }
    }

    function renderDashboard(data) {
      const totalCitas = data.length;
      const agentesUnicos = new Set(data.map(d => d.id_agente)).size;
      const hoy = new Date().toISOString().split("T")[0];
      const citasHoy = data.filter(d => d.fecha_cita?.toString().startsWith(hoy)).length;

      const diferencias = data.map(d => {
        const f1 = new Date(d.fecha_creacion);
        const f2 = new Date(d.fecha_cita);
        return (f2 - f1) / (1000 * 60 * 60 * 24);
      }).filter(v => !isNaN(v));

      const promedioDias = (diferencias.reduce((a,b) => a + b, 0) / diferencias.length).toFixed(1);

      document.getElementById("total-citas").querySelector(".value").textContent = totalCitas;
      document.getElementById("agentes-activos").querySelector(".value").textContent = agentesUnicos;
      document.getElementById("citas-hoy").querySelector(".value").textContent = citasHoy;
      document.getElementById("promedio-tiempo").querySelector(".value").textContent = `${promedioDias} días`;

      renderCharts(data);
      renderCalendar(data);
    }

    function renderCharts(data) {
      const citasPorAgente = {};
      data.forEach(d => {
        const agente = d.id_agente || "Sin agente";
        citasPorAgente[agente] = (citasPorAgente[agente] || 0) + 1;
      });

      new Chart(document.getElementById("citasPorAgente"), {
        type: "bar",
        data: {
          labels: Object.keys(citasPorAgente),
          datasets: [{
            label: "Citas atendidas",
            data: Object.values(citasPorAgente),
            backgroundColor: "#006d3c"
          }]
        },
        options: { responsive: true, plugins: { legend: { display: false } } }
      });

      const statusCount = {};
      data.forEach(d => {
        const status = d.status_cita || "Desconocido";
        statusCount[status] = (statusCount[status] || 0) + 1;
      });

      new Chart(document.getElementById("statusCitas"), {
        type: "doughnut",
        data: {
          labels: Object.keys(statusCount),
          datasets: [{
            data: Object.values(statusCount),
            backgroundColor: ["#006d3c", "#a6e3a1", "#4caf50", "#b2dfdb"]
          }]
        },
        options: { responsive: true }
      });
    }

    function renderCalendar(data) {
      const calendarGrid = document.getElementById("calendar-grid");
      const fechaActual = new Date();
      const ultimoDia = new Date(fechaActual.getFullYear(), fechaActual.getMonth() + 1, 0);
      calendarGrid.innerHTML = "";

      for (let d = 1; d <= ultimoDia.getDate(); d++) {
        const fecha = new Date(fechaActual.getFullYear(), fechaActual.getMonth(), d);
        const citasDelDia = data.filter(c => new Date(c.fecha_cita).toDateString() === fecha.toDateString());

        const cell = document.createElement("div");
        const label = document.createElement("span");
        label.textContent = d;
        cell.appendChild(label);

        if (citasDelDia.length > 0) {
          citasDelDia.forEach(c => {
            const tag = document.createElement("div");
            tag.textContent = c.servicio_motivo;
            tag.style.background = "#a6e3a1";
            tag.style.marginTop = "2px";
            tag.style.borderRadius = "4px";
            tag.style.padding = "2px 4px";
            tag.style.fontSize = "0.75rem";
            cell.appendChild(tag);
          });
        }

        calendarGrid.appendChild(cell);
      }
    }
  </script>
</body>
</html>
